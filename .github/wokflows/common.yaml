name: common-ci-cd

on: 
  workflow_call:
    inputs:
      project:
        required: true
        type: string
      component:
        required: true
        type: string
      app_type:
        required: true
        type: string
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true

jobs:
  ci:
    runs-on: self-hosted
    outputs:
      appVersion: ${{ steps.package-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Check the files
        run: ls -l

      - name: Print inputs
        run: echo "Project: ${{ inputs.project }}, Component: ${{ inputs.component }}, App Type: ${{ inputs.app_type }}"

      - name: Get app version
        id: package-version
        run: |
          version=$(jq -r '.version' package.json)
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Print app version
        run: echo "App Version: ${{ steps.package-version.outputs.version }}"

      - name: Install dependencies
        run: npm install

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5.0.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Cleanup old Docker images
        run: |
          docker rmi 351818465616.dkr.ecr.us-east-1.amazonaws.com/${{ inputs.project }}/${{ inputs.component }}:${{ steps.package-version.outputs.version }} || true

      - name: Build Docker image
        run: |
          docker build --no-cache -t 351818465616.dkr.ecr.us-east-1.amazonaws.com/${{ inputs.project }}/${{ inputs.component }}:${{ steps.package-version.outputs.version }} .

      - name: Ensure ECR repository exists
        run: |
          aws ecr describe-repositories --repository-names ${{ inputs.project }}/${{ inputs.component }} || \
          aws ecr create-repository --repository-name ${{ inputs.project }}/${{ inputs.component }}

      - name: Push Docker image to ECR
        run: |
          aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 351818465616.dkr.ecr.us-east-1.amazonaws.com
          docker push 351818465616.dkr.ecr.us-east-1.amazonaws.com/${{ inputs.project }}/${{ inputs.component }}:${{ steps.package-version.outputs.version }}

  cd:
    runs-on: self-hosted
    needs: ci
    env:
      appVersion: ${{ needs.ci.outputs.appVersion }}
    steps:
      - name: Checkout deploy repo
        uses: actions/checkout@v5
        with:
          repository: joindevops-actions/catalogue-deploy

      - name: Check the files
        run: ls -l

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5.0.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Authenticate to EKS
        run: |
          aws eks update-kubeconfig --region us-east-1 --name roboshop-dev
          kubectl get nodes

      - name: Deploy to EKS
        run: |
          helm upgrade --install ${{ inputs.component }} -f values-dev.yaml --set deployment.imageVersion="$appVersion" .
